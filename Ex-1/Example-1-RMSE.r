
#####################   IPW estimator    #####################################
ipw <- function(dat)
{ 
  sum(dat$D*dat$y/dat$ex)/length(dat$y) 
}


###  stablized  IPW estimator    #############################################
###  Kang and Schafer, 2007, Statistics Science 
###        Hajek estimator          ##########################################
sipw <- function(dat)
{  
  sum(dat$D*dat$y/dat$ex)/sum(dat$D/dat$ex) 
}


###  Improved IPW estimator of Zong, Zhu and Zou (2019)   #################### 
###  need to know all the population sampling weights
###              to calculate crit.  
ipw.zzz <- function(dat)
{ 
    N   = length(dat$y)
    index = 1:N
    tmp = sort( dat$ex )
    i = max( which( tmp < 1/(index+1) ) ) 
    crit = tmp[i] 
    
    ex.star = dat$ex  
    ex.star[which(dat$ex <=crit)] = crit
    sum(dat$D*dat$y/ex.star)/N 
}

#####  Trimmed IPW estimator of Crump et al (2009)   #########################    
ipw.chim <- function(dat)
{ 
    tempfun <- function(a) { 
        u = dat$ex*(1- dat$ex)
        v = a*(1-a)  
        z = (u>=v)  
        a + (2*v*sum( z/u )  >  sum(z) )
    }   
    a =  optimize(tempfun, lower=1e-5, upper=0.5, maximum=FALSE)$minimum  

    N   = length(dat$y)
    y   = rep(dat$y,  dat$D)
    pw  = rep(dat$ex, dat$D) 

    ind = ( pw>a & pw< 1-a)
    y.star  = y[ind]
    pw.star = pw[ind]
    sum(y.star/pw.star)/sum(1/pw.star)   
}

 

#############################   Our ELW estimator ############################  
elw  <- function(dat)
{ 
    y   = rep(dat$y, dat$D)
    pw  = rep(dat$ex, dat$D) 
    N   = length(dat$y) 

    n   = sum(dat$D) 
    xi  = n/N + (1-n/N)*pw
    low = min(pw);   
    up  = min(xi)-eeps    

    fun     <- function(alpha){  sum((pw-alpha)/(xi-alpha)) }
    alpha   <- uniroot(fun, interval=c(low, up), tol=1e-8)$root
    lambda  =  (N/n-1)/(1-alpha)      
    tmp     =  1+lambda*(pw-alpha) 
    prob.el =  1/(n*tmp) 
   
    sum(y*prob.el)  
 }


 

####  Robust IPW estimator of  Wang and Ma, 2017, JASA   ##################### 
 
ipw.trim<-function(dat)
{ N = length(dat$D)
  n = sum(dat$D) 

  fun1<-function(t, s){  2*n*t^s*mean(dat$ex<=t) - 1 }
  bn1=uniroot(fun1, c(0, 1), s=1)$root 
  bn2=uniroot(fun1, c(0, 1), s=2)$root 

  fun2<-function(t){  n*t^5*mean(dat$ex<=t) - 1  }
  hn=uniroot(fun2, c(0, 1))$root  

  yy = rep(dat$y, dat$D)
  pw = rep(dat$ex,dat$D)
  xx = cbind(rep(1,n),  pw)
  ww = (pw<hn)
  xx1 = cbind(ww,  ww*pw)
  bet = ginv(t(xx1)%*%xx)%*%t(xx1)%*%yy 
  xx.all = cbind(rep(1, N), dat$ex)

  Bnb1 =  - mean( (xx.all%*%bet)*(dat$ex<bn1) )
  ipw.trim1 =  mean(yy*(pw >= bn1)/pw) *n/N            
  ipw.bc1 = ipw.trim1-Bnb1 

  Bnb2 =  - mean( (xx.all%*%bet)*(dat$ex<bn2) )
  ipw.trim2 =  mean(yy*(pw >= bn2)/pw)*n/N
  ipw.bc2 = ipw.trim2 -Bnb2

  c(ipw.bc1, ipw.bc2)
}

 

##############################################################################    
simu.one<-function(nrep, gam, N, fun_index, coef)
{
  dat0 = data.gen(gam, 200000, fun_index, coef)
  my   = mean(dat0$y) 
  result=NULL
  for( i in 1:nrep){ 
     # set.seed(i*10+5)
      dat    = data.gen(gam, N, fun_index, coef)  
      est    = c( ipw(dat), sipw(dat), ipw.zzz(dat), 
                  ipw.chim(dat),  ipw.trim(dat),  elw(dat)) 
      result = rbind(result, est)
   }   
  rmse  = sqrt( apply( (result-my)^2, 2, mean))  
  list(result=result, rmse= sqrt(N)*rmse)
} 

###############################################################################
####    Generate data 
data.gen<- function(gam, N, fun_index, coef)
{
   ex  = (runif(N))^(1/(gam-1))
   eta = (rchisq(N, 4)-4)/sqrt(8)  
   reg = (fun_index==1)*cos(2*pi*ex) + (fun_index==2)*(1-ex) + 
           (fun_index==3)*(5+cos(2*pi*ex))+ (fun_index==4)*(1-ex+5)
   y =  reg + eta*coef    
   D   = rbinom(N, 1, ex)
   dat = list(y=y, ex=ex, D=D)
   return(dat)
}



################################################################################
simu.plot<-function(nrep, gam, N, fun_index, coef)
{
   dat0 = data.gen(gam, 200000, fun_index, coef)
   my   = mean(dat0$y) 
   result=NULL
   for( i in 1:nrep){
     # set.seed(i*10+5)
      dat    = data.gen(gam, N, fun_index, coef)
      est    = c( ipw(dat), sipw(dat),  ipw.zzz(dat),  
                     ipw.chim(dat), ipw.trim(dat), elw(dat))
      result = rbind(result, est)
    }

   ############################################################## 
   ############          boxplot     ############################
   gam1 = gam*10
   coef1=10*coef
   txt = paste('N=', N,   '-Model=', fun_index, '-gamma=', 
                                    gam1, '-c=', coef1, sep='')
   flnm = paste('d:/', txt, '.pdf',   sep='')
   pdf(flnm)
   xnm = c('SIPW', 'ZZZ', 'CHIM',  'MW1', 'MW2', 'ELW' )
   boxplot(result[, -1], xaxt='n', xlab='',
               main=paste('N=', N,   ',  Model=', fun_index, ', gamma=', gam, ',  c=', coef, sep='')
           )
   abline(h=my)
   axis(1, 1:6, labels=xnm)
   dev.off()
   ############################################################## 

   rmse = sqrt(N* apply((result-my)^2, 2,mean ))
   rmse = c(N, gam,  coef, fun_index,  rmse )
   rmse = matrix(round(rmse, 4), 1)
   colnames(rmse)=c('N', 'gamma','c', 'Model',   'IPW', xnm )
   print(rmse)
   return(rmse)
}
 



################################################################################
start.time=proc.time() 
library(sampling)
library(MASS)
eeps=sqrt(.Machine$double.eps)    #### root of machine precision

nrep=5000 
NN=c(50, 500, 2000)
gamm=c(1.3, 1.5, 1.9, 2.5)
cff = c(1,  0.1) 

rmse.all = NULL
for(i in 1:3){
   N = NN[i]
   for(k in 1:4){
      gam = gamm[k] 
      for(a in 1:2){
        coef = cff[a]
        for(j in 1:4){  
            fun_index = j 
            rmse = simu.plot(nrep, gam, N, fun_index, coef)
            rmse.all = rbind(rmse.all, rmse)
         }
      }
   }
}

 
ratio = rmse.all[,9]/rmse.all[,11] 
result= round(cbind(rmse.all, ratio ), 2)
result

end.time=proc.time()
cpu.time = end.time-start.time
print(cpu.time)





################################################################################
################################################################################
###    simulation results  

> ratio = rmse.all[,9]/rmse.all[,11] 
> result= round(cbind(rmse.all, ratio ), 2)
> result
         N gamma   c Model    IPW  SIPW   ZZZ  CHIM   MW1   MW2   ELW ratio
 [1,]   50   1.3 1.0     1  18.55  4.58  3.83   NaN 28.81 32.82  4.82  5.98
 [2,]   50   1.3 1.0     2  16.18  3.47  3.81  3.47 19.92 22.86  3.80  5.24
 [3,]   50   1.3 1.0     3 167.94  4.62 18.69  4.62  9.83  7.96  4.94  1.99
 [4,]   50   1.3 1.0     4  76.39  3.50 18.59  3.50 21.22 23.34  3.89  5.45
 [5,]   50   1.3 0.1     1  41.04  3.34  2.96  3.35  2.80  3.03  3.15  0.89
 [6,]   50   1.3 0.1     2  13.52  1.43  2.95  1.43  3.22  3.58  0.88  3.64
 [7,]   50   1.3 0.1     3 120.61  3.35 18.18  3.35  7.62  4.28  3.14  2.42
 [8,]   50   1.3 0.1     4 357.10  1.44 18.66  1.44  6.99  3.75  0.88  7.91
 [9,]   50   1.5 1.0     1  28.03  3.57  3.04  3.57 11.57 15.10  3.61  3.20
[10,]   50   1.5 1.0     2  18.64  2.76  2.91  2.76  4.66  5.33  2.86  1.63
[11,]   50   1.5 1.0     3  46.17  3.62 13.14  3.62  8.21  5.98  3.67  2.23
[12,]   50   1.5 1.0     4  57.44  2.89 13.55  2.89  8.70  6.91  2.95  2.95
[13,]   50   1.5 0.1     1   6.71  2.46  2.08  2.46  1.68  1.73  2.29  0.73
[14,]   50   1.5 0.1     2  20.73  1.08  2.09  1.08  1.24  0.98  0.67  1.84
[15,]   50   1.5 0.1     3  41.40  2.40 12.96  2.40  7.12  3.70  2.24  3.18
[16,]   50   1.5 0.1     4  47.84  1.09 13.32  1.09  7.21  4.19  0.68 10.63
[17,]   50   1.9 1.0     1   3.62  2.59  2.22  2.59  2.66  2.91  2.55  1.04
[18,]   50   1.9 1.0     2   3.25  2.11  2.12  2.11  3.09  3.87  2.09  1.47
[19,]   50   1.9 1.0     3  17.61  2.64  8.37  2.64  6.19  4.61  2.59  2.39
[20,]   50   1.9 1.0     4  14.96  2.16  8.84  2.16  6.90  6.13  2.09  3.30
[21,]   50   1.9 0.1     1   3.40  1.62  1.31  1.62  1.19  1.26  1.54  0.77
[22,]   50   1.9 0.1     2   2.63  0.77  1.28  0.77  0.87  0.59  0.50  1.74
[23,]   50   1.9 0.1     3  20.52  1.61  8.20  1.61  5.71  3.65  1.56  3.66
[24,]   50   1.9 0.1     4  14.74  0.77  8.80  0.77  6.24  4.26  0.50 12.39
[25,]   50   2.5 1.0     1   2.12  1.91  1.76  1.91  2.03  2.26  1.88  1.08
[26,]   50   2.5 1.0     2   1.98  1.64  1.65  1.64  1.92  2.24  1.63  1.18
[27,]   50   2.5 1.0     3   7.54  1.91  5.57  1.91  4.61  3.84  1.91  2.41
[28,]   50   2.5 1.0     4   8.16  1.64  6.30  1.64  5.19  4.42  1.61  3.23
[29,]   50   2.5 0.1     1   1.28  1.11  0.99  1.11  1.00  1.08  1.10  0.91
[30,]   50   2.5 0.1     2   1.18  0.56  0.81  0.56  2.09  2.91  0.40  5.26
[31,]   50   2.5 0.1     3   7.28  1.10  5.40  1.10  4.27  3.23  1.09  3.92
[32,]   50   2.5 0.1     4   7.69  0.56  6.08  0.56  4.95  3.92  0.40 12.35
[33,]  500   1.3 1.0     1  35.05  7.60  7.16  7.60  5.63  5.38  7.02  0.80
[34,]  500   1.3 1.0     2  16.66  6.23  7.24  6.23  5.38  4.83  6.66  0.81
[35,]  500   1.3 1.0     3 287.99  7.86 35.45  7.83 16.38  8.22  7.03  2.33
[36,]  500   1.3 1.0     4 187.03  6.09 35.34  6.08 16.40  8.05  6.77  2.42
[37,]  500   1.3 0.1     1  20.06  5.02  5.76  5.02  3.08  2.69  1.67  1.85
[38,]  500   1.3 0.1     2  17.46  2.14  5.82  2.14  2.54  1.06  0.86  2.94
[39,]  500   1.3 0.1     3 164.15  5.06 34.81  5.06 15.37  6.60  1.67  9.18
[40,]  500   1.3 0.1     4 102.58  2.18 35.37  2.18 15.26  6.64  0.88 17.40
[41,]  500   1.5 1.0     1   9.95  5.30  4.53  5.30  4.08  3.79  4.31  0.95
[42,]  500   1.5 1.0     2  33.06  4.57  4.52  4.57  3.96  3.47  4.21  0.94
[43,]  500   1.5 1.0     3  60.29  5.58 20.69  5.58 13.56  7.41  4.51  3.01
[44,]  500   1.5 1.0     4  80.85  4.76 21.27  4.75 13.82  7.91  4.17  3.31
[45,]  500   1.5 0.1     1  11.41  3.68  3.43  3.68  2.22  1.81  1.64  1.36
[46,]  500   1.5 0.1     2  20.22  1.64  3.39  1.64  2.08  1.04  0.66  3.15
[47,]  500   1.5 0.1     3  81.50  3.68 20.63  3.68 12.91  6.77  1.62  7.98
[48,]  500   1.5 0.1     4  69.71  1.64 20.76  1.64 13.35  7.15  0.67 19.86
[49,]  500   1.9 1.0     1   4.66  3.51  2.72  3.51  2.67  2.47  2.81  0.95
[50,]  500   1.9 1.0     2   6.34  2.84  2.65  2.84  2.57  2.39  2.36  1.09
[51,]  500   1.9 1.0     3  17.44  3.37 10.89  3.37  9.03  6.12  2.80  3.22
[52,]  500   1.9 1.0     4  25.61  2.73 11.24  2.73  9.40  6.75  2.42  3.88
[53,]  500   1.9 0.1     1   3.00  2.26  1.71  2.26  1.43  1.14  1.46  0.98
[54,]  500   1.9 0.1     2   5.23  1.05  1.71  1.05  1.35  0.89  0.52  2.59
[55,]  500   1.9 0.1     3  24.14  2.27 10.80  2.27  8.69  5.76  1.48  5.86
[56,]  500   1.9 0.1     4  19.14  1.05 10.96  1.05  9.12  6.45  0.52 17.54
[57,]  500   2.5 1.0     1   2.13  2.08  1.89  2.08  1.90  1.89  1.99  0.96
[58,]  500   2.5 1.0     2   2.00  1.74  1.80  1.74  1.81  1.75  1.66  1.09
[59,]  500   2.5 1.0     3   7.34  2.03  6.31  2.03  5.75  4.76  1.97  2.92
[60,]  500   2.5 1.0     4   8.06  1.82  6.90  1.82  6.38  5.46  1.67  3.83
[61,]  500   2.5 0.1     1   1.29  1.26  1.09  1.26  1.02  0.92  1.16  0.88
[62,]  500   2.5 0.1     2   1.19  0.65  0.93  0.65  0.84  0.66  0.41  2.03
[63,]  500   2.5 0.1     3   7.38  1.27  6.04  1.27  5.48  4.40  1.17  4.67
[64,]  500   2.5 0.1     4   7.72  0.63  6.76  0.63  6.23  5.21  0.41 15.27
[65,] 2000   1.3 1.0     1  64.24 11.64 10.67 11.62  7.17  6.55 10.14  0.71
[66,] 2000   1.3 1.0     2  85.88  9.65 10.53  9.65  6.81  5.30  9.61  0.71
[67,] 2000   1.3 1.0     3 551.35 11.77 51.40 11.23 24.07 10.77  9.85  2.44
[68,] 2000   1.3 1.0     4 360.02  9.80 51.91  9.44 24.23 10.34  9.80  2.47
[69,] 2000   1.3 0.1     1  26.76  6.87  8.51  6.84  4.51  4.14  1.67  2.70
[70,] 2000   1.3 0.1     2 192.71  2.98  8.48  2.96  3.86  1.49  1.10  3.52
[71,] 2000   1.3 0.1     3 468.48  6.98 51.37  6.94 23.46  9.47  1.80 13.01
[72,] 2000   1.3 0.1     4 502.15  3.00 52.02  2.98 24.17  9.18  1.29 18.80
[73,] 2000   1.5 1.0     1  24.72  8.05  6.05  8.00  4.96  4.35  5.51  0.90
[74,] 2000   1.5 1.0     2  17.89  6.17  5.95  6.17  4.84  3.78  5.13  0.94
[75,] 2000   1.5 1.0     3  69.08  7.49 27.27  7.49 18.29  9.59  5.21  3.51
[76,] 2000   1.5 1.0     4 110.80  6.49 27.11  6.49 18.31  9.83  5.21  3.52
[77,] 2000   1.5 0.1     1  14.76  4.89  4.48  4.87  3.00  2.52  1.60  1.88
[78,] 2000   1.5 0.1     2  26.23  2.16  4.44  2.15  2.88  1.36  0.71  4.03
[79,] 2000   1.5 0.1     3  68.12  4.74 27.04  4.73 17.81  8.94  1.61 11.09
[80,] 2000   1.5 0.1     4 140.05  2.21 26.86  2.19 18.02  9.03  0.74 24.44
[81,] 2000   1.9 1.0     1   6.96  4.21  2.98  4.21  2.89  2.73  2.92  0.99
[82,] 2000   1.9 1.0     2   5.97  3.14  2.98  3.14  2.83  2.46  2.59  1.09
[83,] 2000   1.9 1.0     3  17.61  3.85 12.49  3.85 10.60  7.38  2.98  3.56
[84,] 2000   1.9 1.0     4  19.28  3.02 12.86  3.02 11.10  8.12  2.61  4.26
[85,] 2000   1.9 0.1     1   9.63  2.68  2.05  2.59  1.70  1.35  1.47  1.16
[86,] 2000   1.9 0.1     2   3.32  1.29  1.96  1.29  1.65  1.09  0.52  3.17
[87,] 2000   1.9 0.1     3  19.43  2.62 12.16  2.62 10.36  7.08  1.45  7.13
[88,] 2000   1.9 0.1     4  26.20  1.27 12.65  1.27 10.81  7.70  0.54 20.08
[89,] 2000   2.5 1.0     1   2.11  2.11  1.97  2.11  1.93  1.87  2.02  0.95
[90,] 2000   2.5 1.0     2   2.06  1.81  1.90  1.81  1.89  1.82  1.72  1.10
[91,] 2000   2.5 1.0     3   7.64  2.15  6.77  2.15  6.33  5.32  2.05  3.09
[92,] 2000   2.5 1.0     4   8.14  1.85  7.31  1.85  6.87  6.01  1.70  4.03
[93,] 2000   2.5 0.1     1   1.49  1.33  1.14  1.33  1.07  0.98  1.17  0.92
[94,] 2000   2.5 0.1     2   1.22  0.69  1.01  0.69  0.93  0.77  0.42  2.19
[95,] 2000   2.5 0.1     3   7.63  1.31  6.60  1.31  6.21  5.14  1.18  5.26
[96,] 2000   2.5 0.1     4   8.26  0.68  7.13  0.68  6.80  5.85  0.42 16.30
> 
> end.time=proc.time()
> cpu.time = end.time-start.time
> print(cpu.time)
   用户    系统    流逝 
1145.49    4.26 1180.48 
> 

